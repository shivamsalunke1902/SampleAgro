
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroMind Storage Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%23dbeafe' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.99-7.5L26 15v18.5l-13 7.5L0 33.5V15z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: #1f2937;
        }
        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            border-color: #22c55e;
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
        }
        .header-gradient {
            background: linear-gradient(90deg, #1f2937, #22c55e, #1f2937);
            background-size: 200% 200%;
            animation: gradient-animation 10s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .btn-primary {
            background: #22c55e;
            color: #ffffff;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: #16a34a;
            transform: scale(1.05);
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #1f2937;
            border: 1px solid #cbd5e1;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: #cbd5e1;
            transform: scale(1.05);
        }
        .alert-danger { background-color: #fef2f2; color: #b91c1c; border-color: #fecaca; }
        .alert-warning { background-color: #fffbeb; color: #b45309; border-color: #fde68a; }
        .alert-safe { background-color: #f0fdf4; color: #166534; border-color: #dcfce7; }
        .dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; }
        .dot-red { background-color: #ef4444; box-shadow: 0 0 6px #ef4444; }
        .dot-green { background-color: #22c55e; box-shadow: 0 0 6px #22c55e; }
        .dot-yellow { background-color: #f59e0b; box-shadow: 0 0 6px #f59e0b; }
        .decision-sell { color: #16a34a; border-color: #16a34a; background-color: #f0fdf4; }
        .decision-preserve { color: #4338ca; border-color: #4338ca; background-color: #eef2ff; }
        .decision-urgent { color: #b91c1c; border-color: #b91c1c; background-color: #fef2f2; }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Paho MQTT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto space-y-8">
        <!-- Header -->
        <header class="text-center mb-10 p-6 rounded-2xl header-gradient">
            <h1 class="text-5xl font-extrabold text-white" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">AgroMind</h1>
            <p class="text-lg mt-2 text-gray-200">Intelligent Storage Management</p>
        </header>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Key Info & Decision Support -->
            <div class="lg:col-span-1 space-y-6">

                <!-- RESTRUCTURED: Status and Alerts now in a vertical stack for better mobile view -->
                <!-- Status Card -->
                <div class="card p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4">Connection Status</h2>
                    <div class="flex items-center space-x-3 mb-2">
                        <span id="connDot" class="dot dot-yellow"></span>
                        <span id="connStatus" class="font-semibold text-yellow-600">Connecting...</span>
                    </div>
                    <p id="client-id" class="text-sm text-gray-500 truncate">Client ID: </p>
                </div>
                <!-- Alerts Panel -->
                <div id="alertsArea" class="card p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-2">Real-time Alerts</h2>
                    <div id="alert-messages" class="space-y-2">
                        <div class="alert-safe p-3 rounded-lg border text-sm">No active alerts. Optimal conditions.</div>
                    </div>
                </div>
                
                <!-- Live Data Metrics -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="card p-4 rounded-xl text-center">
                        <i class="fas fa-thermometer-half text-3xl mb-2 text-red-500"></i>
                        <p class="text-sm text-gray-500">Temperature</p>
                        <p id="tempVal" class="text-3xl font-bold mt-1 text-glow">--</p>
                        <p class="text-xs text-gray-400">&deg;C</p>
                    </div>
                    <div class="card p-4 rounded-xl text-center">
                        <i class="fas fa-water text-3xl mb-2 text-blue-500"></i>
                        <p class="text-sm text-gray-500">Humidity</p>
                        <p id="humVal" class="text-3xl font-bold mt-1 text-glow">--</p>
                        <p class="text-xs text-gray-400">%</p>
                    </div>
                    <div class="card p-4 rounded-xl text-center">
                        <i class="fas fa-seedling text-3xl mb-2 text-green-500"></i>
                        <p class="text-sm text-gray-500">Stored Crop</p>
                        <p id="currentCrop" class="text-2xl font-bold mt-1">--</p>
                    </div>
                    <div class="card p-4 rounded-xl text-center">
                        <i class="fas fa-chart-line text-3xl mb-2 text-yellow-500"></i>
                        <p class="text-sm text-gray-500">Market Price</p>
                        <p id="latestPrice" class="text-2xl font-bold mt-1 text-glow">--</p>
                    </div>
                </div>

                <!-- ENHANCED: Decision Support Card -->
                <div class="card p-6 rounded-xl space-y-4">
                    <h2 class="text-xl font-bold">Decision Support</h2>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-500">Current Price</p>
                            <p id="currentPriceDisplay" class="text-2xl font-bold text-gray-800">--</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Forecast Price (3 mo.)</p>
                            <p id="futurePriceDisplay" class="text-2xl font-bold text-blue-600">--</p>
                        </div>
                    </div>
                     <div class="pt-2">
                        <p class="text-sm text-gray-500 mb-1">Profit/Loss Forecast (per kg)</p>
                        <p id="profitLoss" class="text-3xl font-bold text-center text-gray-500">--</p>
                    </div>
                    <div id="decisionRecommendation" class="p-4 rounded-lg border-2 text-center transition-all duration-300">
                        <p class="font-bold text-lg">Awaiting data...</p>
                        <p class="text-sm">Provide market price for analysis.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Charts & Controls -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Live Charts -->
                <div class="card p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4">Live Readings & Market Trend</h2>
                    <div class="flex items-center justify-between mb-4 text-sm text-gray-500">
                        <span>Temp (°C), Hum (%), and Price (₹)</span>
                        <span>Points: <span id="pointCount">0</span></span>
                    </div>
                    <div class="w-full h-80">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                 <!-- Controls moved to Right Column -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Preservation & Market Controls -->
                    <div class="card p-6 rounded-xl space-y-4">
                        <h2 class="text-xl font-bold">Crop & Market Tools</h2>
                        <div>
                            <label for="cropSelect" class="block text-sm text-gray-500 mb-1">Select Crop</label>
                            <div class="flex space-x-2">
                                <select id="cropSelect" class="flex-1 bg-gray-100 border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="wheat">Wheat</option>
                                    <option value="rice">Rice</option>
                                    <option value="potato">Potato</option>
                                    <option value="onion">Onion</option>
                                    <option value="maize">Maize</option>
                                    <option value="tomato">Tomato</option>
                                </select>
                                <button id="refreshBtn" class="btn-secondary px-4 rounded-lg text-sm">Refresh</button>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Preservation Estimate</p>
                            <div class="flex items-center space-x-2">
                                <p id="preserveDays" class="text-3xl font-bold">-- days</p>
                                <span id="preserveNote" class="text-xs text-gray-400">Calculating...</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label for="marketInput" class="block text-sm text-gray-500">Manual Price (₹/kg)</label>
                            <div class="flex space-x-2">
                                <input id="marketInput" type="number" placeholder="Enter price" class="flex-1 bg-gray-100 border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                                <button id="sendPrice" class="btn-primary px-4 rounded-lg text-sm">Send</button>
                            </div>
                        </div>
                    </div>

                    <!-- Device Controls -->
                    <div class="card p-6 rounded-xl space-y-4">
                        <h2 class="text-xl font-bold">Device Controls</h2>
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-sm text-gray-500">LED Status</p>
                                <p id="ledState" class="text-xl font-bold">--</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="ledToggle" class="btn-primary px-4 py-2 rounded-lg text-sm">Toggle LED</button>
                                <button id="reqStatus" class="btn-secondary px-4 py-2 rounded-lg text-sm">Request Status</button>
                            </div>
                        </div>
                         <div class="pt-2">
                            <label for="futureDemand" class="block text-sm text-gray-500 mb-1">Future Demand Outlook</label>
                             <div class="flex items-center space-x-2">
                                <span class="text-xs">Low</span>
                                <input id="futureDemand" type="range" min="0.8" max="1.5" value="1.1" step="0.05" class="w-full">
                                <span class="text-xs">High</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="card p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">History Log</h2>
                        <button id="csvBtn" class="btn-secondary px-4 py-2 rounded-lg text-sm"><i class="fas fa-file-csv mr-2"></i>Export to CSV</button>
                    </div>
                    <div class="overflow-auto max-h-64">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-left text-gray-500 border-b border-gray-200">
                                    <th class="py-2 px-2">Time</th>
                                    <th class="py-2 px-2">Crop</th>
                                    <th class="py-2 px-2">Temp (°C)</th>
                                    <th class="py-2 px-2">Hum (%)</th>
                                    <th class="py-2 px-2">Price (₹/kg)</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Message Box -->
    <div id="statusMessage" class="fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white font-medium transition-all duration-300 transform translate-x-full"></div>

    <script>
        // --- Configuration & Initialization ---
        const BROKER = "broker.hivemq.com";
        const WSS_PORT = 8884;
        const MQTT_PATH = "/mqtt";
        const CLIENT_ID = "web_" + Math.random().toString(16).substr(2, 8);
        const TOPIC_DHT = "esp32/dht";
        const TOPIC_MARKET = "esp32/market";
        const TOPIC_LED = "esp32/led";
        const TOPIC_BUTTON = "esp32/button";

        const CROP_CONFIG = {
            wheat: { name: "Wheat", baseDays: 180, tmin: 5, tmax: 25, hmin: 45, hmax: 65, basePrice: 22, storageCost: 0.05 },
            rice: { name: "Rice", baseDays: 120, tmin: 10, tmax: 30, hmin: 50, hmax: 70, basePrice: 25, storageCost: 0.06 },
            potato: { name: "Potato", baseDays: 90, tmin: 4, tmax: 15, hmin: 85, hmax: 95, basePrice: 18, storageCost: 0.08 },
            onion: { name: "Onion", baseDays: 120, tmin: 0, tmax: 25, hmin: 60, hmax: 70, basePrice: 30, storageCost: 0.10 },
            maize: { name: "Maize", baseDays: 150, tmin: 5, tmax: 30, hmin: 50, hmax: 70, basePrice: 20, storageCost: 0.04 },
            tomato: { name: "Tomato", baseDays: 20, tmin: 10, tmax: 18, hmin: 85, hmax: 95, basePrice: 40, storageCost: 0.25 }
        };

        let trendChart;
        let history = []; // {ts, crop, temp, hum, price}
        const MAX_POINTS = 120;
        let lastPrice = null;
        let lastPreservationDays = null;
        let ledState = "UNKNOWN";
        let mqttClient;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('client-id').textContent += CLIENT_ID;
            setupCharts();
            connectMqtt();
            setupEventListeners();
        });

        // --- MQTT Connection & Handlers ---
        function connectMqtt() {
            document.getElementById('connStatus').textContent = 'Connecting...';
            document.getElementById('connDot').className = 'dot dot-yellow';
            mqttClient = new Paho.MQTT.Client(BROKER, WSS_PORT, MQTT_PATH, CLIENT_ID);
            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;
            mqttClient.connect({
                onSuccess: onConnect,
                useSSL: true,
                keepAliveInterval: 30,
            });
        }

        function onConnect() {
            console.log("Connected to MQTT Broker!");
            document.getElementById('connStatus').textContent = 'Connected';
            document.getElementById('connDot').className = 'dot dot-green';
            mqttClient.subscribe(TOPIC_DHT);
            mqttClient.subscribe(TOPIC_MARKET);
            mqttClient.subscribe(TOPIC_LED);
            setTimeout(() => { publish(TOPIC_BUTTON, "STATUS"); }, 800);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost:", responseObject.errorMessage);
                document.getElementById('connStatus').textContent = 'Disconnected';
                document.getElementById('connDot').className = 'dot dot-red';
                showStatusMessage("Connection to MQTT broker lost.", 'danger');
                setTimeout(connectMqtt, 5000);
            }
        }

        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payloadString = message.payloadString;

            if (topic === TOPIC_LED) {
                handleLED(payloadString);
                return;
            }

            try {
                const payload = JSON.parse(payloadString);
                switch (topic) {
                    case TOPIC_DHT: handleDHT(payload); break;
                    case TOPIC_MARKET: handleMarket(payload); break;
                }
            } catch (e) {
                console.error(`Failed to parse JSON message on topic ${topic}:`, e, "Payload:", payloadString);
            }
        }

        function publish(topic, payload) {
            if (mqttClient && mqttClient.isConnected()) {
                const msg = new Paho.MQTT.Message(typeof payload === 'string' ? payload : JSON.stringify(payload));
                msg.destinationName = topic;
                mqttClient.send(msg);
            } else {
                console.warn("MQTT client is not connected.");
                showStatusMessage("Error: Not connected to MQTT broker.", 'danger');
            }
        }

        // --- UI Updates & Logic ---
        function handleDHT(data) {
            const ts = new Date(data.ts || Date.now());
            const temp = Number(data.temp);
            const hum = Number(data.hum);
            const crop = document.getElementById('cropSelect').value;
            const price = data.price !== undefined ? Number(data.price) : lastPrice;

            document.getElementById('tempVal').textContent = isNaN(temp) ? '--' : temp.toFixed(1);
            document.getElementById('humVal').textContent = isNaN(hum) ? '--' : hum.toFixed(1);
            document.getElementById('currentCrop').textContent = CROP_CONFIG[crop]?.name || crop.toUpperCase();
            
            const newHistoryEntry = { ts: ts.toISOString(), crop, temp, hum, price };
            history.push(newHistoryEntry);
            if (history.length > MAX_POINTS) history.shift();

            syncChart(newHistoryEntry);
            addHistoryRow(newHistoryEntry);
            updatePreservationEstimate(crop, temp, hum);
            checkAlerts(temp, hum, crop);
            updatePrice(price);
            document.getElementById('pointCount').textContent = history.length;
        }

        function handleMarket(data) {
            const price = Number(data.price);
            if (!isNaN(price)) updatePrice(price);
        }
        
        function handleLED(status) {
            ledState = status;
            document.getElementById('ledState').textContent = status;
        }

        function updatePrice(price) {
            if (price === null) return;
            document.getElementById('latestPrice').textContent = `₹${price.toFixed(2)}`;
            lastPrice = price;
            updateDecisionUI(); 
        }
        
        // --- ENHANCED: Decision Support Logic ---
        function calculateFuturePrice() {
            const cropKey = document.getElementById('cropSelect').value;
            const crop = CROP_CONFIG[cropKey] || CROP_CONFIG.wheat;
            const demandMultiplier = parseFloat(document.getElementById('futureDemand').value);
            const futurePrice = crop.basePrice * demandMultiplier * (1 + (Math.random() - 0.5) * 0.1);
            return futurePrice;
        }

        function updateDecisionUI() {
            const recommendationBox = document.getElementById('decisionRecommendation');
            const profitLossEl = document.getElementById('profitLoss');

            if (lastPreservationDays === null) {
                recommendationBox.innerHTML = `<p class="font-bold text-lg">Awaiting sensor data...</p>`;
                return;
            }

            if (lastPreservationDays < 15) {
                recommendationBox.className = 'p-4 rounded-lg border-2 text-center transition-all duration-300 decision-urgent';
                recommendationBox.innerHTML = `<p class="font-bold text-lg"><i class="fas fa-exclamation-triangle mr-2"></i>SELL URGENTLY</p><p class="text-sm">Low preservation time (${lastPreservationDays} days). Sell now to avoid spoilage.</p>`;
                document.getElementById('currentPriceDisplay').textContent = lastPrice ? `₹${lastPrice.toFixed(2)}` : '--';
                document.getElementById('futurePriceDisplay').textContent = '--';
                profitLossEl.textContent = 'N/A';
                profitLossEl.className = 'text-3xl font-bold text-center text-gray-500';
                return;
            }

            if (lastPrice === null) {
                recommendationBox.className = 'p-4 rounded-lg border-2 text-center transition-all duration-300';
                recommendationBox.innerHTML = `<p class="font-bold text-lg">Awaiting data...</p><p class="text-sm">Provide market price for analysis.</p>`;
                return;
            }

            const currentPrice = lastPrice;
            const futurePrice = calculateFuturePrice();
            const cropKey = document.getElementById('cropSelect').value;
            const storageCost = CROP_CONFIG[cropKey]?.storageCost || 0.1;
            const netFuturePrice = futurePrice - (storageCost * 90); // 3 months storage cost
            const profitLoss = netFuturePrice - currentPrice;
            
            profitLossEl.textContent = `${profitLoss >= 0 ? '+' : '-'} ₹${Math.abs(profitLoss).toFixed(2)}`;
            profitLossEl.className = `text-3xl font-bold text-center ${profitLoss >= 0 ? 'text-green-600' : 'text-red-600'}`;

            document.getElementById('currentPriceDisplay').textContent = `₹${currentPrice.toFixed(2)}`;
            document.getElementById('futurePriceDisplay').textContent = `₹${futurePrice.toFixed(2)}`;

            if (profitLoss > 2 && lastPreservationDays > 90) { 
                recommendationBox.className = 'p-4 rounded-lg border-2 text-center transition-all duration-300 decision-preserve';
                recommendationBox.innerHTML = `<p class="font-bold text-lg"><i class="fas fa-hourglass-half mr-2"></i>PRESERVE</p><p class="text-sm">Profit forecast is high and storage time is sufficient (${lastPreservationDays} days).</p>`;
            } else {
                recommendationBox.className = 'p-4 rounded-lg border-2 text-center transition-all duration-300 decision-sell';
                recommendationBox.innerHTML = `<p class="font-bold text-lg"><i class="fas fa-tags mr-2"></i>SELL NOW</p><p class="text-sm">Current market price is favorable. Holding may not be profitable.</p>`;
            }
        }
        
        function updatePreservationEstimate(cropKey, temp, hum) {
            const cfg = CROP_CONFIG[cropKey] || CROP_CONFIG.wheat;
            let days = cfg.baseDays;

            if (isNaN(temp) || isNaN(hum)) {
                lastPreservationDays = null;
                return;
            }

            const tmin = cfg.tmin, tmax = cfg.tmax;
            if (temp < tmin) days -= (tmin - temp) * 1.5;
            else if (temp > tmax) days -= (temp - tmax) * 4;

            const hmin = cfg.hmin, hmax = cfg.hmax;
            if (hum < hmin) days -= (hmin - hum) * 0.8;
            else if (hum > hmax) days -= (hum - hmax) * 1.2;

            lastPreservationDays = Math.round(Math.max(0, days));
            document.getElementById('preserveDays').textContent = `${lastPreservationDays} days`;
            document.getElementById('preserveNote').textContent = (temp > tmax || hum > hmax) ? "Warning: suboptimal." : "Conditions are ideal.";
        }

        function checkAlerts(temp, hum, crop) {
            const cfg = CROP_CONFIG[crop] || CROP_CONFIG.wheat;
            const alerts = [];
            if (temp > cfg.tmax + 3) alerts.push(`High temp (${temp.toFixed(1)}°C) — spoilage risk.`);
            if (hum > cfg.hmax + 6) alerts.push(`High humidity (${hum.toFixed(1)}%) — mold risk.`);
            
            const alertsArea = document.getElementById('alert-messages');
            alertsArea.innerHTML = '';
            
            if (alerts.length === 0) {
                alertsArea.innerHTML = `<div class="alert-safe p-3 rounded-lg border text-sm">No active alerts. Optimal conditions.</div>`;
            } else {
                alerts.forEach(alertText => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-danger p-3 rounded-lg border text-sm';
                    alertDiv.textContent = alertText;
                    alertsArea.appendChild(alertDiv);
                });
            }
        }
        
        // --- Chart & Table Functions ---
        function setupCharts() {
            const chartOptions = {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { grid: { color: '#e5e7eb' }, ticks: { color: '#6b7280' } },
                    yTemp: { type: 'linear', position: 'left', title: { display: true, text: '°C', color: '#dc2626' }, grid: { drawOnChartArea: false }, ticks: { color: '#6b7280' } },
                    yHum: { type: 'linear', position: 'right', title: { display: true, text: '%', color: '#3b82f6' }, grid: { drawOnChartArea: false }, ticks: { color: '#6b7280' } },
                    yPrice: { type: 'linear', position: 'right', title: { display: true, text: '₹', color: '#f59e0b' }, grid: { drawOnChartArea: false }, ticks: { color: '#6b7280' }, display: false }
                },
                plugins: { legend: { labels: { boxWidth: 10, color: '#6b7280' } } }
            };
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Temperature (°C)', data: [], tension: 0.3, yAxisID: 'yTemp', pointRadius: 1, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)' },
                        { label: 'Humidity (%)', data: [], tension: 0.3, yAxisID: 'yHum', pointRadius: 1, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)' },
                        { label: 'Price (₹/kg)', data: [], tension: 0.3, yAxisID: 'yPrice', pointRadius: 2, borderColor: '#f59e0b', borderWidth: 2, borderDash: [5, 5] }
                    ]
                },
                options: chartOptions
            });
        }

        function syncChart(newData) {
            if (trendChart.data.labels.length >= MAX_POINTS) {
                trendChart.data.labels.shift();
                trendChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            trendChart.data.labels.push(new Date(newData.ts).toLocaleTimeString());
            trendChart.data.datasets[0].data.push(newData.temp);
            trendChart.data.datasets[1].data.push(newData.hum);
            
            const priceData = trendChart.data.datasets[2].data;
            priceData.push(newData.price);
            const hasPriceData = priceData.some(p => p !== null);
            trendChart.options.scales.yPrice.display = hasPriceData;
            
            trendChart.update('none');
        }

        function addHistoryRow({ ts, crop, temp, hum, price }) {
            const historyBody = document.getElementById('historyTableBody');
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-200 hover:bg-gray-50';
            tr.innerHTML = `
                <td class="py-2 px-2">${new Date(ts).toLocaleString()}</td>
                <td class="py-2 px-2">${CROP_CONFIG[crop]?.name || crop}</td>
                <td class="py-2 px-2">${isNaN(temp) ? '--' : temp.toFixed(1)}</td>
                <td class="py-2 px-2">${isNaN(hum) ? '--' : hum.toFixed(1)}</td>
                <td class="py-2 px-2 font-semibold">${price === null ? '--' : `₹${price.toFixed(2)}`}</td>
            `;
            historyBody.prepend(tr);
            if (historyBody.children.length > 50) historyBody.removeChild(historyBody.lastChild);
        }
        
        // --- Event Listeners ---
        function setupEventListeners() {
            document.getElementById('refreshBtn').addEventListener('click', () => {
                const cur = document.getElementById('cropSelect').value;
                const last = history[history.length - 1];
                if (last) {
                    updatePreservationEstimate(cur, last.temp, last.hum);
                    updateDecisionUI();
                }
            });

            document.getElementById('futureDemand').addEventListener('input', updateDecisionUI);
            document.getElementById('cropSelect').addEventListener('change', updateDecisionUI);

            document.getElementById('csvBtn').addEventListener('click', () => {
                if (history.length === 0) { showStatusMessage("No data to export.", 'warning'); return; }
                let csv = "time,crop,temp,hum,price\n";
                history.forEach(r => { csv += `${r.ts},${r.crop},${r.temp},${r.hum},${r.price === null ? '' : r.price}\n`; });
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `agromind_history_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);
            });

            document.getElementById('sendPrice').addEventListener('click', () => {
                const v = parseFloat(document.getElementById('marketInput').value);
                if (isNaN(v)) { showStatusMessage("Please enter a valid price.", 'danger'); return; }
                publish(TOPIC_MARKET, JSON.stringify({ price: v, ts: Date.now(), crop: document.getElementById('cropSelect').value }));
                document.getElementById('marketInput').value = "";
            });

            document.getElementById('ledToggle').addEventListener('click', () => publish(TOPIC_BUTTON, "TOGGLE"));
            document.getElementById('reqStatus').addEventListener('click', () => publish(TOPIC_BUTTON, "STATUS"));
        }
        
        function showStatusMessage(message, type) {
            const messageBox = document.getElementById('statusMessage');
            let bgColor = (type === 'safe') ? 'bg-green-500' : (type === 'warning') ? 'bg-yellow-500' : 'bg-red-500';

            messageBox.className = `fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white font-medium transition-all duration-300 transform translate-x-full ${bgColor}`;
            messageBox.textContent = message;

            setTimeout(() => { messageBox.classList.remove('translate-x-full'); }, 50);
            setTimeout(() => { messageBox.classList.add('translate-x-full'); }, 3000);
        }
        
        window.addEventListener("beforeunload", () => {
            try { if (mqttClient && mqttClient.isConnected()) mqttClient.disconnect(); } catch (e) {}
        });
    </script>
</body>
</html>
